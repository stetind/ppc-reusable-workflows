# =============================================================================
# 📦 NPM Publish
#
# This workflow publishes Node.js packages to npm registry:
# - Supports both production and development releases
# - Handles version updates automatically
# - Configurable for different environments and runners
#
# Inputs:
#   - release_version_name: Version for npm package
#   - is_dev_release: Whether this is a development release
#   - dev_release_tag_name: Tag for dev releases (default: dev)
#   - runner: GitHub runner to use (default: ubuntu-latest)
#   - job_container: Docker container image (default: node:22.14)
#
# Required Secrets:
#   - NPM_TOKEN: npm registry authentication token
#
# Trigger: workflow_call
# =============================================================================


name: Npm - Publish

on:
  workflow_call:
    inputs:
      release_version_name:
        description: The name of the version that will be used to publish release on NPM.
        type: string
        required: true
      is_dev_release:
        description: Mark the publish as dev or not.
        type: boolean
        default: false
        required: false
      dev_release_tag_name:
        description: The name of the tag that will be used to publish a dev release on NPM.
        type: string
        default: dev
        required: false
      runner:
        description: 'Choose the runner'
        required: false
        default: 'ubuntu-latest'
        type: string
      job_container:
        description: 'Select the docker container for the action'
        required: false
        default: 'node:22.14'
        type: string

jobs:
  publish:
    runs-on: ${{ inputs.runner }}
    container: ${{ inputs.job_container }}
    env:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
      NODE_ENV: ${{ inputs.is_dev_release && 'development' || 'production' }}

    steps:
      - name: 🛫 Checkout
        uses: actions/checkout@v4

      - name: 🔧 Setup Node and NPM
        uses: stetind/ppc-github-composite-actions/.github/actions/intall-global-dependencies@v1.1.1
        with:
          npm_token: $NPM_TOKEN
          production: ${{ !inputs.is_dev_release }}

      - name: 🏗️ Building Environment
        run: npm run build --if-present && npx browserslist@latest --update-db

      - name: 🚀 Update version
        run: npm --no-git-tag-version version ${{ inputs.release_version_name }}
        env:
          NODE_AUTH_TOKEN: $NPM_TOKEN

      - name: 🐱‍🚀 Publish Dev
        if: "inputs.is_dev_release"
        run: npm publish --tag ${{ inputs.dev_release_tag_name }}
        env:
          NODE_AUTH_TOKEN: $NPM_TOKEN

      - name: 🐱‍🚀 Publish Release
        if: "!inputs.is_dev_release"
        run: npm publish
        env:
          NODE_AUTH_TOKEN: $NPM_TOKEN
