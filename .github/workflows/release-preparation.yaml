# =============================================================================
# ğŸš§ Release Preparation Workflow
#
# Description:
#   A reusable workflow that prepares repository for a new release by handling
#   versioning, file updates, and metadata creation.
#
# Key Features:
#   â€¢ Semantic version computation from commit history
#   â€¢ Automated version placeholder updates
#   â€¢ Release metadata generation
#   â€¢ Temporary branch management
#
# Required Permissions:
#   â€¢ WORKFLOW_TOKEN: Repository write access
#   â€¢ Git: Full history access (fetch-depth: 0)
#
# Inputs:
#   â€¢ tag: Release version override (optional)
#   â€¢ prerelease: Pre-release identifier (optional)
#   â€¢ merge_option: Branch handling strategy
#   â€¢ runner: CI runner selection
#   â€¢ job_container: Container configuration
#   â€¢ temp_branch: Temporary branch name
#
# Outputs:
#   â€¢ Metadata file (.release-meta.json)
#   â€¢ Updated workflow files with new version
#
# Usage:
#   Called by prepare-new-release.yaml
# =============================================================================


name: ğŸš§ Release Preparation Workflow
run-name: ğŸš§ Release Preparation Workflow

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Optional tag version (e.g., v1.0.0). Leave empty for the latest tag.'
        required: false
        type: string
      prerelease:
        description: 'Optional prerelease identifier (e.g., beta, rc). Leave empty for stable.'
        required: false
        type: string
      merge_option:
        description: 'Merge and cleanup option'
        required: false
        type: choice
        default: 'merge and delete'
        options:
          - 'merge and delete'
          - 'merge'
          - 'none'
      runner:
        description: 'Choose the runner'
        required: false
        default: 'ubuntu-latest'
        type: choice
        options:
          - 'self-hosted'
          - 'ubuntu-latest'
      job_container:
        description: 'Select the docker container for the action'
        required: false
        default: 'ubuntu:latest'
        type: choice
        options:
          - 'node:22.14'
          - 'ubuntu:latest'
      temp_branch:
        description: 'Name of the temporary branch for staging release changes. Must match branch used in run-release workflow'
        required: false
        default: 'releases'
        type: string
  workflow_call:
    inputs:
      tag:
        description: 'Version tag to use for the release (e.g., v1.0.0). If not specified, will use the latest tag'
        required: false
        type: string
      prerelease:
        description: 'Identifier for pre-release versions (e.g., beta, rc). Leave empty for stable releases'
        required: false
        type: string
      merge_option:
        description: 'Controls how changes are merged after release preparation:
          - merge and delete: merges changes and removes temporary branch
          - merge: only merges changes
          - none: keeps changes in temporary branch'
        required: false
        type: string
        default: 'merge and delete'
      runner:
        description: 'GitHub runner to execute the workflow (e.g., ubuntu-latest, self-hosted)'
        required: false
        default: 'ubuntu-latest'
        type: string
      job_container:
        description: 'Docker container image to run the job (e.g., node:22.14)'
        required: false
        default: 'ubuntu:latest'
        type: string
      temp_branch:
        description: 'Name of the temporary branch for staging release changes. Must match branch used in run-release workflow'
        required: false
        default: 'releases'
        type: string

jobs:
  prepare:
    name: Prepare & Push
    runs-on: ${{ inputs.runner }}

    steps:
      - name: ğŸ”§ Install gh
        uses: stetind/ppc-github-composite-actions/.github/actions/check-install-gh@v1.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”§ Install Jq
        uses: stetind/ppc-github-composite-actions/.github/actions/check-install-jq@v1.0.0

      - name: ğŸ”§ Install Git
        uses: stetind/ppc-github-composite-actions/.github/actions/check-install-git@v1.0.0

      - name: ğŸ”§ Setup Git
        uses: stetind/ppc-github-composite-actions/.github/actions/git-setup@v1.0.0

      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ·ï¸ Get latest tag
        id: get_tag
        shell: bash
        run: |
          # Loop through the latest releases and find the most recent published release tag
            set -e
          
            latest_tag=$(gh release list --limit 100 --json tagName,isDraft,isPrerelease \
              --jq '.[] | select(.isDraft == false and .isPrerelease == false) | .tagName' \
              | head -n 1)
          
          if [[ -n "$latest_tag" ]]; then
            echo "latest_tag=$latest_tag" >> $GITHUB_OUTPUT
            echo "::notice ::Latest published semver tag found: $latest_tag"
          else
            echo "::warning ::No valid semver published release tag found, using 0.0.0"
            echo "latest_tag=0.0.0" >> $GITHUB_OUTPUT
          fi
#        env:
#          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¦ Get commits since selected tag
        id: get_commits
        uses: stetind/ppc-github-composite-actions/.github/actions/get-commits-since-tag@v1.0.0
        with:
          tag: ${{ inputs.tag || steps.latest_tag.outputs.latest_tag }}

      - name: ğŸ” Detect version bump and compute new version
        id: detect_version
        if: steps.get_commits.outputs.commits != ''
        uses: stetind/ppc-github-composite-actions/.github/actions/detect-version-bump@v1.0.0
        with:
          commits: ${{ steps.get_commits.outputs.commits }}
          tag: ${{ inputs.previous_tag }}

      - name: ğŸ§ª Generate changelog
        id: changelog
        if: steps.get_commits.outputs.commits != ''
        uses: stetind/ppc-github-composite-actions/.github/actions/generate-changelog@v1.0.0
        with:
          commits: ${{ steps.get_commits.outputs.commits }}
          previous_tag: ${{ inputs.tag || steps.latest_tag.outputs.latest_tag }}
          new_tag: ${{ steps.detect_version.outputs.new_version }}
          repository: ${{ github.repository }}

      - name: Replace __VERSION__ placeholders
        if: steps.get_commits.outputs.commits != ''
        run: |
          echo "Replacing version with ${{ steps.changelog.outputs.new_tag }}"
          find .github/workflows -type f -name "*.yaml" \
            -exec sed -i "s|__VERSION__|${{ steps.changelog.outputs.new_tag }}|g" {} +

      - name: ğŸ’¾ Write release metadata
        if: steps.get_commits.outputs.commits != ''
        run: |
          cat <<EOF > .release-meta.json
          {
            "previous_tag": "${{ steps.latest_tag.outputs.selected_tag }}",
            "new_tag": "${{ steps.changelog.outputs.new_tag }}",
            "prerelease": "${{ github.event.inputs.prerelease || '' }}",
            "merge_option": "${{ github.event.inputs.merge_option || 'none' }}",
            "source_branch": "${{ github.ref_name }}"
          }
          EOF

      - name: Commit & Push to ${{ inputs.temp_branch }}
        if: steps.get_commits.outputs.commits != ''
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -B ${{ inputs.temp_branch }}
          git add .github/workflows/*.yaml
          git add .github/*.yaml
          git add .release-meta.json
          git add README.md
          git commit -m "Prepare release for version ${{ steps.changelog.outputs.new_tag }}"
          git push origin ${{ inputs.temp_branch }} --force