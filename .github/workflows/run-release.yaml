name: 🚀 Run Release from Branch

on:
  push:
    branches:
      - releases

jobs:
  read_metadata_and_delegate:
    name: Read Metadata & Trigger Reusable Release Workflow
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.read_meta.outputs.tag }}
      prerelease: ${{ steps.read_meta.outputs.prerelease }}
    steps:
      - name: ⬇️ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 🔍 Read .release-meta.json
        id: read_meta
        run: |
          if [ ! -f .release-meta.json ]; then
            echo "::error ::.release-meta.json file not found!"
            exit 1
          fi

          PREVIOUS_TAG=$(jq -r '.previous_tag' .release-meta.json)
          NEW_TAG=$(jq -r '.new_tag' .release-meta.json)
          PRERELEASE=$(jq -r '.prerelease' .release-meta.json)

          echo "previous_tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT
          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT
          echo "prerelease=$PRERELEASE" >> $GITHUB_OUTPUT

  call_reusable_release:
    name: Final Release
    needs: read_metadata_and_delegate
    uses: stetind/ppc-reusable-workflows/.github/workflows/auto-release-based-conventional-commits.yaml@releases
    secrets: inherit
    with:
      previous_tag: ${{ needs.read_metadata_and_delegate.outputs.previous_tag }}
      new_tag: ${{ needs.read_metadata_and_delegate.outputs.new_tag }}
      prerelease: ${{ needs.read_metadata_and_delegate.outputs.prerelease }}
