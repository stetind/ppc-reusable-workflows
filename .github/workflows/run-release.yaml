name: 🚀 Run Release from Branch

on:
  push:
    branches:
      - releases

jobs:
  read_metadata_and_delegate:
    name: Read Metadata & Trigger Reusable Release Workflow
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.read_meta.outputs.tag }}
      prerelease: ${{ steps.read_meta.outputs.prerelease }}
      force: ${{ steps.read_meta.outputs.force }}
    steps:
      - name: ⬇️ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 🔍 Read .release-meta.json
        id: read_meta
        run: |
          if [ ! -f .release-meta.json ]; then
            echo "::error ::.release-meta.json file not found!"
            exit 1
          fi

          TAG=$(jq -r '.tag' .release-meta.json)
          PRERELEASE=$(jq -r '.prerelease' .release-meta.json)
          FORCE=$(jq -r '.force' .release-meta.json)

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "prerelease=$PRERELEASE" >> $GITHUB_OUTPUT
          echo "force=$FORCE" >> $GITHUB_OUTPUT

  call_reusable_release:
    name: Final Release
    needs: read_metadata_and_delegate
    uses: stetind/ppc-reusable-workflows/.github/workflows/auto-release-based-conventional-commits.yaml@releases
    secrets: inherit
    with:
      tag: ${{ needs.read_metadata_and_delegate.outputs.tag }}
      prerelease: ${{ needs.read_metadata_and_delegate.outputs.prerelease }}
      force: "${{ needs.read_metadata_and_delegate.outputs.force }}"
