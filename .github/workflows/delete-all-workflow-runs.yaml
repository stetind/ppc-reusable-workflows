name: üßπ Delete All Workflow Runs
run-name: üßπ Delete all runs of workflow (${{ inputs.workflow_name }}) with status = ${{ inputs.status }}

on:
  workflow_call:
    inputs:
      status:
        description: |
          Optional status filter for workflow runs. Available options:
          ‚Ä¢ completed - All completed runs
          ‚Ä¢ action_required - Runs that require action
          ‚Ä¢ cancelled - Manually cancelled runs
          ‚Ä¢ failure - Failed runs
          ‚Ä¢ neutral - Runs with neutral outcome
          ‚Ä¢ skipped - Skipped runs
          ‚Ä¢ stale - Stale runs
          ‚Ä¢ success - Successful runs
          ‚Ä¢ timed_out - Runs that exceeded time limit
          ‚Ä¢ queued - Queued runs
          ‚Ä¢ requested - Requested runs
          ‚Ä¢ waiting - Waiting runs
          ‚Ä¢ pending - Pending runs
        type: string
        required: false
        default: 'cancelled'
      workflow_name:
        description: 'The name of the workflow to delete runs for (e.g., "CI Workflow")'
        required: false
        type: string
      runner:
        description: 'Choose the runner'
        required: false
        default: 'ubuntu-latest'
        type: string
      job_container:
        description: 'Select the docker container for the action'
        required: false
        default: 'node:22.14'
        type: string

  workflow_dispatch:
    inputs:
      status:
        description: |
          Optional status filter for workflow runs. Available options:
          ‚Ä¢ completed - All completed runs
          ‚Ä¢ action_required - Runs that require action
          ‚Ä¢ cancelled - Manually cancelled runs
          ‚Ä¢ failure - Failed runs
          ‚Ä¢ neutral - Runs with neutral outcome
          ‚Ä¢ skipped - Skipped runs
          ‚Ä¢ stale - Stale runs
          ‚Ä¢ success - Successful runs
          ‚Ä¢ timed_out - Runs that exceeded time limit
          ‚Ä¢ queued - Queued runs
          ‚Ä¢ requested - Requested runs
          ‚Ä¢ waiting - Waiting runs
          ‚Ä¢ pending - Pending runs
        type: choice
        required: false
        default: 'cancelled'
        options:
          - completed
          - action_required
          - cancelled
          - failure
          - neutral
          - skipped
          - stale
          - success
          - timed_out
          - queued
          - requested
          - waiting
          - pending
      workflow_name:
        description: 'The name of the workflow to delete runs for (e.g., "CI Workflow")'
        required: false
        type: string
      runner:
        description: 'Choose the runner'
        required: false
        default: 'ubuntu-latest'
        type: choice
        options:
          - 'self-hosted'
          - 'ubuntu-latest'
      job_container:
        description: 'Select the docker container for the action'
        required: false
        default: 'node:22.14'
        type: choice
        options:
          - 'node:22.14'
          - 'ubuntu:latest'

jobs:
  cleanup:
    runs-on: ${{ inputs.runner }}
    container: ${{ inputs.job_container }}

    steps:
      - name: üì¶ Install dependencies
        run: |
          echo "üì• Updating package lists..."
          apt-get update && \
          echo "‚öôÔ∏è Installing required packages..." && \
          apt-get install -y \
            jq \
            bash \
            curl \
            gh && \
          echo "‚úÖ Dependencies installed successfully!"


      - name: üîê Authenticate with GitHub CLI
        shell: bash
        run: echo "${{ secrets.WORKFLOW_TOKEN }}" | gh auth login --with-token

      - name: üßº Delete all workflow runs
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_TOKEN }}
        run: |
          echo "üöÄ Fetching and deleting all workflow runs..."
          # Initialize counters for different statuses
          declare -A status_counts=()
          
          current_run_id="${{ github.run_id }}"
          workflow_name="${{ inputs.workflow_name }}"
          
          # GitHub logging for workflow info
          echo "::notice::Starting cleanup process for repository: ${{ github.repository }}"
          
          # First, let's list all workflows to see the exact name
          echo "üìã Available workflows:"
          gh api "/repos/${{ github.repository }}/actions/workflows" | jq -r '.workflows[].name'
          
          echo "üö´ Current run ID: $current_run_id (will be skipped)"
          echo "::debug::üö´ Current run ID: $current_run_id (will be skipped)"
          if [ -n "$workflow_name" ]; then
            echo "üîç Targeting workflow: $workflow_name"
            echo "::notice::üîç Targeting specific workflow: $workflow_name"
          fi

          per_page=100
          page=1
          deleted_count=0
          failed_count=0

          while true; do
            echo "üîÑ Fetching page $page..."
            echo "::debug::üîÑ Fetching page $page..."

            url="/repos/${{ github.repository }}/actions/runs?per_page=$per_page&page=$page"
            if [ -n "${{ inputs.status }}" ]; then
              url="${url}&status=${{ inputs.status }}"
              echo "üìé Filtering runs by status: ${{ inputs.status }}"
              echo "::debug::Filtering runs by status: ${{ inputs.status }}"
            fi
            
            if [ -n "$workflow_name" ]; then
              workflow_id=$(gh api "/repos/${{ github.repository }}/actions/workflows" | \
                          jq -r --arg name "$workflow_name" '.workflows[] | select(.name==$name) | .id')
              if [ -n "$workflow_id" ]; then
                url="${url}&workflow_id=$workflow_id"
                echo "üéØ Found workflow ID: $workflow_id"
                echo "::debug::üéØ Found workflow ID: $workflow_id"
              else
                echo "‚ùå Error: Could not find workflow with name: $workflow_name"
                echo "::error::‚ùå Could not find workflow with name: $workflow_name"
                exit 1
              fi
            fi

            response=$(gh api -X GET "$url")
            total_count=$(echo "$response" | jq -r '.total_count')
            
            if [ "$total_count" -eq 0 ]; then
              echo "‚úÖ No more runs to delete."
              echo "::notice::‚úÖ No more runs to delete."
              break
            fi

            echo "$response" | jq -r '.workflow_runs[]? | select(.id != null) | "\(.id) \(.conclusion)"' | while read -r run_id status; do
              if [ "$run_id" = "$current_run_id" ]; then
                echo "‚è≠Ô∏è Skipping current run $run_id"
                echo "::debug::‚è≠Ô∏è Skipping current run $run_id"
                continue
              fi
              
              echo "::debug::Deleting run $run_id (Status: $status)"
              if gh api --method DELETE "/repos/${{ github.repository }}/actions/runs/$run_id"; then
                ((deleted_count+=1))
                # Update status counts (need to use a file due to subshell limitations)
                echo "$status" >> /tmp/status_counts
              else
                ((failed_count+=1))
                echo "‚ùå Failed to delete run $run_id"
                echo "::warning::‚ùå Failed to delete run $run_id"
              fi
              sleep 0.5
            done

            ((page+=1))
          done

          # Process status counts from temporary file
          echo "::notice::=== Deletion Summary ==="
          echo "::notice::Total deleted runs: $deleted_count"
          if [ $failed_count -gt 0 ]; then
            echo "::warning::Failed deletions: $failed_count"
          fi
          
          # Count occurrences of each status
          if [ -f /tmp/status_counts ]; then
            echo "::notice::Deleted runs by status:"
            sort /tmp/status_counts | uniq -c | while read -r count status; do
              echo "::notice::  - $status: $count"
            done
            rm /tmp/status_counts
          fi

          if [ $failed_count -gt 0 ]; then
            echo "::warning::Cleanup completed with $failed_count failures"
          else
            echo "::notice::Cleanup completed successfully"
          fi