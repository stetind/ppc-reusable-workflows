# =============================================================================
# ðŸš€ Auto Release Based on Conventional Commits
#
# This reusable workflow creates GitHub releases automatically:
# - Analyzes conventional commits to determine version bump
# - Generates changelog from commit history
# - Creates GitHub release (stable or prerelease)
#
# Inputs:
#   - tag: Optional fixed version (skips bump logic)
#   - new_tag: Optional specific version to use
#   - prerelease: Optional prerelease identifier (beta/rc)
#   - branch: Target branch (default: current ref)
#   - draft: Create as draft release (default: false)
#   - runner: GitHub runner to use
#   - job_container: Docker container image
#
# Outputs:
#   - tag: The version name
#   - prerelease: Whether this is a prerelease
#   - prerelease_suffix: The prerelease suffix
#   - has_changes: Whether there are changes to release
#
# Trigger: workflow_call
# =============================================================================

name: ðŸš€ Auto Release Based on Conventional Commits
run-name: >-
  ${{ 
    format(
      '`{0}` Release ({1}{2})', 
      github.event.inputs.prerelease && github.event.inputs.prerelease != '' && github.event.inputs.prerelease != 'none' && 'Staging' || 'PRODUCTION', 
      github.event.inputs.tag || 'latest',
      github.event.inputs.prerelease && github.event.inputs.prerelease != '' && github.event.inputs.prerelease != 'none' && format(', Pre-release: {0}', github.event.inputs.prerelease) || ''
    ) 
  }}

on:
  workflow_call:
    outputs:
      tag:
        description: "The version name"
        value: ${{ jobs.release.outputs.new_version }}
      prerelease:
        description: "Describe if the version is prerelease or not"
        value: ${{ jobs.release.outputs.prerelease }}
      prerelease_suffix:
        description: "The prerelease suffix"
        value: ${{ jobs.release.outputs.prerelease_suffix }}
      has_changes:
        description: "Describe if the release has changes or not"
        value: ${{ jobs.release.outputs.has_changes }}

    inputs:
      tag:
        description: 'Optional tag version (e.g., v1.0.0). Leave empty for the latest tag.'
        required: false
        type: string
      new_tag:
        description: 'Optional tag version (e.g., v1.0.0).'
        required: false
        type: string
        default: ''
      prerelease:
        description: 'Optional prerelease identifier (e.g., beta, rc). Leave empty for stable.'
        required: false
        type: string
      branch:
        required: false
        type: string
        default: ${{ github.ref_name }}
      release_notes:
        required: true
        type: string
        default: ''
      draft:
        required: false
        type: boolean
        default: false
      runner:
        description: 'Choose the runner'
        required: false
        default: 'ubuntu-latest'
        type: string
      job_container:
        description: 'Select the docker container for the action'
        required: false
        default: 'node:22.14'
        type: string

jobs:
  release:
    name: Create Release
    runs-on: ${{ inputs.runner }}
    container: ${{ inputs.job_container }}
    outputs:
      tag: ${{ steps.changelog.outputs.new_tag }}
      prerelease: ${{ inputs.prerelease != '' && inputs.prerelease != 'none' }}
      prerelease_suffix: ${{ inputs.prerelease }}
      has_changes: ${{ steps.changelog.outputs.has_changes }}

    steps:
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}
          fetch-depth: 0

      - name: ðŸ“¦ Check if release exists
        id: check_release_exists
        run: |
          release_exists=$(gh release view ${{ inputs.tag }} --json name --jq ".name" || echo "not_found")
          if [[ "$release_exists" != "not_found" ]]; then
            echo "::error ::Release with tag ${{ inputs.tag }} already exists. Exiting."
            exit 1
          else
            echo "::notice ::No existing release found, proceeding with release creation."
          fi

      - name: Decode Release Notes
        id: release_notes
        if: inputs.release_notes != '' && steps.check_release_exists.outcome == 'success'
        run: |
          # Define the function
          is_base64() {
            local string="$1"
            echo "$string" | base64 -d > /dev/null 2>&1
            return $?
          }
            
          CONTENT="${{ inputs.release_notes }}"
          
          if is_base64 "$CONTENT"; then
            RELEASE_NOTES=$($CONTENT | base64 -d)
            echo "::notice ::Content was base64 encoded"
          else
            RELEASE_NOTES=$CONTENT 
            echo "::notice ::Content was not encoded to base64"
          fi
          
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$RELEASE_NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ðŸ“¤ Create GitHub Release
        if: inputs.release_notes != '' && steps.release_notes.outcome == 'success'
        uses: stetind/ppc-github-composite-actions/.github/actions/create-github-release@v1.0.0
        with:
          version: ${{ inputs.tag }}
          changelog: ${{ steps.release_notes.outputs.notes }}
          prerelease: ${{ inputs.prerelease != '' && inputs.prerelease != 'none' }}
          target_branch: ${{ inputs.branch }}
          draft: ${{ inputs.draft }}

      - name: ðŸ“Ÿ Final Summary
        if: success()
        run: |
          new_version="${{ steps.detect_version.outputs.new_version }}"
          repo="${{ github.repository }}"
          release_url="https://github.com/${repo}/releases/tag/${new_version}"
          
          echo "::notice ::ðŸ“† Release Summary"
          echo "::notice ::ðŸ”– Tag: $new_version"
          if [[ "${{ inputs.prerelease }}" != "" && "${{ inputs.prerelease }}" != "none" ]]; then
            echo "::notice ::ðŸš§ Pre-release: ${{ inputs.prerelease }}"
          else
            echo "::notice ::âœ… Production Release"
          fi
          echo "::notice ::ðŸ”— URL: $release_url"
          echo "::notice ::ðŸŽ‰ Release successfully created!"